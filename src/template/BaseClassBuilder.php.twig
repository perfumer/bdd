<?php

namespace Generated\{{ context.namespace }};

{% if context.extendsClass %}
abstract class {{ context.className }} extends {{ context.extendsClass }}
{% else %}
abstract class {{ context.className }}
{% endif %}
{
{% for variable in context.properties %}
    protected ${{ variable }};
{% endfor %}

{% for step in context.stepHeaders %}
{% if step.type in ['validator', 'formatter'] %}
    abstract public function {{ step.functionName }}({{ method_arguments(step.arguments) }});
{% endif %}
{% if step.type == 'call' and step.service is null %}
    abstract protected function {{ step.functionName }}({{ method_arguments(step.arguments) }});
{% endif %}
{% if step.type == 'call' and step.service is not null and step.service != '_parent' %}
    final private function {{ step.functionName }}({{ method_arguments(step.arguments) }})
    {
        {% if step.return %}return {% endif %}$this->{{ step.service }}->{{ step.method }}({{ method_arguments(step.arguments) }});
    }
{% endif %}
{% endfor %}

{% for action in context.actions %}
    final public function {{ action.methodName }}({{ method_arguments(action.methodArguments) }})
    {
        $_error = null;
        $_return = null;
{% for variable in action.localVariables %}
        ${{ variable }} = null;
{% endfor %}

{% for step in action.steps %}
        if ($_error === null) {
{% if step.type == 'validator' %}
            $_error = $this->{{ step.functionName }}({{ call_arguments(step.arguments) }});
{% elseif step.type == 'call' %}
{% if step.service == '_parent' %}
            {{ return_value(step.return) }}parent::{{ action.methodName }}({{ call_arguments(step.arguments) }});
{% else %}
            {{ return_value(step.return) }}$this->{{ step.functionName }}({{ call_arguments(step.arguments) }});
{% endif %}
{% elseif step.type == 'formatter' %}
            {{ return_value(step.return) }}$this->{{ step.functionName }}({{ call_arguments(step.arguments) }});
{% endif %}
        }
{% endfor %}

        if ($_error !== null) {
            return $_error;
        }

        return $_return;
    }

{% endfor %}
}
